<!DOCTYPE html>
<html lang="lo">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>‡ªÄ‡∫Å‡∫° ‡∫Å‡∫¥‡∫ô‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÑ‡∫õ‡∫ô‡∫≠‡∫ô</title>

        <!-- Tailwind (CDN) -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Inter font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
        
        <!-- Lao font (Noto Sans Lao Looped) -->
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao+Looped:wght@400;600;700&display=swap" rel="stylesheet">


        <style>
            :root{
                --bg-1: #0f172a; /* slate-900 */
                --bg-2: #0b1220;
                --accent: #f59e0b; /* amber-500 */
            }
            html,body{height:100%}
            body{
                /* Use Noto Sans Lao Looped first, then fallback to Inter */
                font-family: 'Noto Sans Lao Looped', 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
                background: radial-gradient(1200px 600px at 10% 20%, rgba(245,158,11,0.06), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
                color: #e6eef8;
                -webkit-font-smoothing:antased;
                -moz-osx-font-smoothing:grayscale;
                margin:0;
                display:flex;
                flex-direction:column;
                min-height:100vh;
                /* Add touch-action: manipulation to prevent double-tap zoom delays on mobile */
                touch-action: manipulation;
                
                /* Disable text selection */
                user-select: none; /* Standard */
                -webkit-user-select: none; /* Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE/Edge */
            }

            /* Card styles */
            .card-wrap{
                width: 90vw; /* Use viewport width for responsiveness */
                max-width: 340px; /* Max size on larger screens */
                height: calc(90vw * 1.4); /* Maintain aspect ratio */
                max-height: 476px; /* Max height based on max-width */
                perspective: 1400px;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
            }
            
            .card{
                width:100%;height:100%;border-radius:18px;background:linear-gradient(180deg,#ffffff,#f8fafc);color:#0f172a;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,0.6);transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.9,.3,1)
            }
            /* This is the flipped (back) state */
            .card.flipped{transform:rotateY(180deg)}
            .card-face{position:absolute;inset:0;backface-visibility:hidden;display:flex;flex-direction:column}
            
            /* Card Front (like 7 of Hearts image) */
            .card-front{
                padding:22px;
            }
            
            /* Card Back (Symmetrical) */
            .card-back{
                transform:rotateY(180deg);
                background:linear-gradient(180deg,#0f172a,#071127);
                color:rgba(255,255,255,0.95);
                align-items:center;
                justify-content:center;
                padding: 22px; /* Added padding */
            }

            .suit-red{color:#dc2626}
            .suit-black{color:#0f172a}

            /* small helpers */
            .muted{color:#9aa5bd}

            /* Modal styles */
            #rule-modal, #rules-modal, #settings-modal, #welcome-modal, #summary-modal {
                transition: opacity 0.3s ease-out;
            }
            #modal-content, #rules-modal-content, #settings-modal-content, #welcome-modal-content, #summary-modal-content {
                transition: all 0.3s ease-out;
            }
            #rule-modal.visible, #rules-modal.visible, #settings-modal.visible, #welcome-modal.visible, #summary-modal.visible {
                opacity: 1;
                visibility: visible;
            }
            #rule-modal.visible > #modal-content,
            #rules-modal.visible > #rules-modal-content,
            #settings-modal.visible > #settings-modal-content,
            #welcome-modal.visible > #welcome-modal-content,
            #summary-modal.visible > #summary-modal-content {
                transform: scale(1);
            }

            /* Language dropdown */
            .lang-dropdown {
                position: relative;
            }
            .lang-dropdown-menu {
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 0.5rem;
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                min-width: 150px;
                z-index: 10;
            }
            .lang-dropdown.active .lang-dropdown-menu {
                display: block;
            }

            /* Player buttons */
            .player-btn {
                transition: all 0.2s;
            }
            .player-btn.selected {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                transform: scale(1.05);
            }

            /* Responsive */
            @media (min-width:768px){
                .card-wrap{
                    width:340px;
                    height:476px;
                }
            }
        </style>
    </head>
    <body class="p-6">

        <!-- Welcome Modal (Player Setup) -->
        <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm opacity-0 invisible overflow-y-auto">
            <div id="welcome-modal-content" class="bg-white text-slate-900 rounded-2xl p-8 shadow-2xl w-full max-w-lg text-center transform scale-95">
                <div class="mb-8">
                    <div class="text-6xl mb-3">üçª</div>
                    <h1 class="text-4xl font-bold mb-2" data-i18n="welcome-title">‡ªÄ‡∫Å‡∫° ‡∫Å‡∫¥‡∫ô‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÑ‡∫õ‡∫ô‡∫≠‡∫ô</h1>
                    <p class="text-slate-500 text-lg" data-i18n="welcome-subtitle">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡ªà‡∫≠‡∫ô‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°</p>
                </div>
                
                <div class="text-left mb-8">
                    <label class="block font-bold mb-3 text-lg" data-i18n="player-count-label">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô:</label>
                    <div class="flex items-center gap-4">
                        <button id="decrease-players" class="px-4 py-3 bg-slate-200 hover:bg-slate-300 rounded-lg font-bold text-2xl transition-colors active:scale-95">‚àí</button>
                        <input type="number" id="player-count" min="1" max="20" value="4" class="flex-1 text-center px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-amber-500 text-2xl font-bold" readonly>
                        <button id="increase-players" class="px-4 py-3 bg-slate-200 hover:bg-slate-300 rounded-lg font-bold text-2xl transition-colors active:scale-95">+</button>
                    </div>
                </div>

                <div class="text-left mb-8">
                    <h3 class="font-bold text-lg mb-3" data-i18n="player-names-required">‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô:</h3>
                    <div id="player-names-container" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Player name inputs will be generated here -->
                    </div>
                </div>

                <!-- Save Players Checkbox -->
                <div class="mb-6 text-left">
                    <label class="flex items-center gap-2 cursor-pointer mb-1">
                        <input type="checkbox" id="save-players-checkbox" class="w-4 h-4 text-amber-500 border-slate-300 rounded focus:ring-amber-500">
                        <span class="text-sm text-slate-600" data-i18n="save-players">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÑ‡∫ß‡ªâ‡ªÉ‡∫ä‡ªâ‡∫Ñ‡∫±‡ªâ‡∫á‡ªú‡ªâ‡∫≤</span>
                    </label>
                    <p class="text-xs text-slate-400 pl-6" data-i18n="save-players-note">(‡∫Å‡∫ª‡∫î '‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà' ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫•‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà‡∫ó‡∫µ‡ªà‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÑ‡∫ß‡ªâ)</p>
                </div>

                <button id="start-game-btn" class="w-full px-6 py-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-xl font-bold transition-all shadow-lg hover:shadow-xl active:scale-95">
                    <span data-i18n="start-game">üéÆ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°</span>
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="w-full max-w-md mx-auto mb-4">
            <div class="flex gap-3 justify-center items-center">
                <button id="rules-btn" class="px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-bold transition-transform hover:bg-slate-600 active:scale-95">
                    <span data-i18n="nav-rules">üìñ ‡∫Å‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤</span>
                </button>
                <button id="settings-btn" class="px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-bold transition-transform hover:bg-slate-600 active:scale-95">
                    <span data-i18n="nav-settings">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤</span>
                </button>
                <div class="lang-dropdown">
                    <button id="lang-btn" class="px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-bold transition-transform hover:bg-slate-600 active:scale-95 flex items-center gap-2">
                        <span>üåê</span>
                        <span id="current-lang">‡∫•‡∫≤‡∫ß</span>
                    </button>
                    <div class="lang-dropdown-menu">
                        <button data-lang="lo" class="w-full px-4 py-2 text-left text-slate-900 hover:bg-slate-100 first:rounded-t-lg transition-colors">üá±üá¶ ‡∫•‡∫≤‡∫ß</button>
                        <button data-lang="en" class="w-full px-4 py-2 text-left text-slate-900 hover:bg-slate-100 transition-colors">üá∫üá∏ English</button>
                        <button data-lang="ja" class="w-full px-4 py-2 text-left text-slate-900 hover:bg-slate-100 transition-colors">üáØüáµ Êó•Êú¨Ë™û</button>
                        <button data-lang="th" class="w-full px-4 py-2 text-left text-slate-900 hover:bg-slate-100 last:rounded-b-lg transition-colors">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="w-full flex flex-col items-center gap-8 py-8 flex-1">
            <!-- Cards Remaining Counter & Reset Button -->
            <div class="flex items-center gap-4">
                <p class="text-lg muted"><span data-i18n="cards-remaining">‡ªÄ‡∫´‡∫º‡∫∑‡∫≠</span> <span id="cards-remaining" class="text-2xl font-bold text-amber-500">52</span> <span data-i18n="cards-unit">‡ªÉ‡∫ö</span></p>
                <button id="reset-btn" class="px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-bold transition-transform hover:bg-slate-600 active:scale-95">
                    <span data-i18n="reset-game">üîÑ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà</span>
                </button>
            </div>

            <!-- Card Display -->
            <div id="card-clickable-area" class="card-wrap focus:outline-none focus:ring-4 focus:ring-amber-400 rounded-[18px]" role="button" tabindex="0" aria-label="Draw a card">
                <!-- Card starts flipped (showing the back) -->
                <div id="card" class="card flipped">
                    
                    <!-- Front face (matches user image) -->
                    <div class="card-face card-front">
                        <div class="flex justify-between items-start">
                            <div id="top-left" class="text-left">
                                <div id="rank-top" class="text-2xl font-extrabold"></div>
                                <div id="suit-top" class="text-xl"></div>
                            </div>
                        </div>
                        <div class="flex-1 flex items-center justify-center">
                            <!-- Large center suit -->
                            <div id="center-suit" class="text-8xl font-extrabold">üëë</div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div></div> <!-- Empty div for spacing -->
                            <!-- Rotated bottom-right corner -->
                            <div id="bottom-right" class="text-right transform rotate-180">
                                <div id="rank-bottom" class="text-2xl font-extrabold"></div>
                                <div id="suit-bottom" class="text-xl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Back face (Symmetrical) -->
                    <div class="card-face card-back">
                         <div class="flex justify-between items-start w-full">
                            <div class="text-left text-2xl muted">üÇ†</div>
                            <div class="text-right text-2xl muted">üÇ†</div>
                        </div>
                        <div class="flex-1 flex items-center justify-center">
                            <div class="text-7xl">üÇ†</div>
                        </div>
                        <div class="flex justify-between items-end w-full">
                            <div class="text-left text-2xl muted transform rotate-180">üÇ†</div>
                            <div class="text-right text-2xl muted transform rotate-180">üÇ†</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Buttons (Drinking Counter) -->
            <div id="players-section" class="w-full max-w-2xl hidden mt-auto">
                <h3 class="text-center text-lg font-bold mb-4 muted" data-i18n="drink-counter">‡∫ô‡∫±‡∫ö‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫à‡∫≠‡∫Å</h3>
                <div id="players-container" class="grid grid-cols-3 gap-3">
                    <!-- Player buttons will be generated here -->
                </div>
            </div>
        </main>

        <!-- Rule Modal -->
        <div id="rule-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm opacity-0 invisible">
            <div id="modal-content" class="bg-white text-slate-900 rounded-2xl p-8 shadow-2xl w-full max-w-sm text-center transform scale-95">
                <!-- Standard Card Display -->
                <div id="modal-card" class="flex items-center justify-center gap-2 mb-4">
                     <div id="modal-rank" class="text-4xl font-extrabold"></div>
                     <div id="modal-suit" class="text-3xl"></div>
                </div>
                
                <!-- Dice Roll UI (hidden by default) -->
                <div id="modal-dice-ui" class="hidden">
                    <div id="modal-dice-roll" class="flex items-center justify-center gap-3 mb-4">
                        <div class="text-6xl">üé≤</div>
                        <div id="dice-result-number" class="text-6xl font-extrabold">?</div>
                    </div>
                    <!-- Dice Result Text (hidden by default) -->
                    <p id="dice-result-text" class="hidden text-3xl font-bold mb-6"></p>
                </div>

                <!-- Rule Text -->
                <p id="modal-rule-text" class="text-xl font-semibold mb-3"></p>
                <p id="modal-rule-desc" class="text-sm text-slate-600 mb-6"></p>
                
                <!-- Dice Roll Button -->
                <button id="modal-roll-dice-btn" class="hidden w-full px-6 py-3 rounded-lg bg-blue-600 text-white text-lg font-bold transition-transform active:scale-95 mb-3 mt-6"> 
                    <span data-i18n="roll-dice">üé≤ Roll Dice</span>
                </button>

                <!-- Close Button (hidden initially for dice roll) -->
                <button id="modal-close-btn" class="w-full px-6 py-3 rounded-lg bg-amber-500 text-black text-lg font-bold transition-transform active:scale-95 mt-6"> 
                    <span data-i18n="understood">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß</span>
                </button>
            </div>
        </div>

        <!-- Rules Modal (all rules) -->
        <div id="rules-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 invisible">
            <div id="rules-modal-content" class="bg-white text-slate-900 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95">
                <div class="p-6 border-b border-slate-200">
                    <h2 class="text-2xl font-bold text-center" data-i18n="all-rules-title">üìñ ‡∫Å‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</h2>
                </div>
                <div id="rules-list" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Rules will be generated here -->
                </div>
                <div class="p-6 border-t border-slate-200">
                    <button id="rules-modal-close-btn" class="w-full px-6 py-3 rounded-lg bg-amber-500 text-black text-lg font-bold transition-transform active:scale-95 hover:bg-amber-600">
                        <span data-i18n="close">‡∫õ‡∫¥‡∫î</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm opacity-0 invisible">
            <div id="settings-modal-content" class="bg-white text-slate-900 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col transform scale-95">
                <div class="p-6 border-b border-slate-200">
                    <h2 class="text-2xl font-bold text-center" data-i18n="settings-title">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤</h2>
                </div>
                <!-- Scrollable list of rule inputs -->
                <div id="settings-rules-list" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Inputs will be generated by JS, this is the container -->
                </div>
                <!-- Footer with buttons -->
                <div class="p-6 border-t border-slate-200 flex gap-4">
                    <button id="reset-rules-btn" class="px-6 py-3 rounded-lg bg-slate-600 text-white font-bold transition-transform hover:bg-slate-500 active:scale-95">
                        <span data-i18n="reset">Reset</span>
                    </button>
                    <button id="save-rules-btn" class="flex-1 px-6 py-3 rounded-lg bg-amber-500 text-black font-bold transition-transform hover:bg-amber-600 active:scale-95">
                        <span data-i18n="save">Save</span>
                    </button>
                    <button id="settings-modal-close-btn" class="px-4 py-3 rounded-lg bg-slate-200 text-slate-800 font-bold transition-transform hover:bg-slate-300 active:scale-95">
                        <span data-i18n="close">Close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Modal -->
        <div id="summary-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm opacity-0 invisible">
            <div id="summary-modal-content" class="bg-white text-slate-900 rounded-2xl shadow-2xl w-full max-w-lg transform scale-95">
                <div class="p-8 text-center">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h2 class="text-3xl font-bold mb-2" data-i18n="game-over">‡ªÄ‡∫Å‡∫°‡∫à‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß!</h2>
                    <p class="text-lg text-slate-500 mb-8" data-i18n="summary-subtitle">‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫î‡∫∑‡ªà‡∫°</p>
                    
                    <div id="summary-list" class="space-y-3 mb-8 max-h-64 overflow-y-auto text-left">
                        <!-- Summary items will be generated here -->
                    </div>

                    <button id="summary-modal-close-btn" class="w-full px-6 py-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-xl font-bold transition-all shadow-lg hover:shadow-xl active:scale-95">
                        <span data-i18n="play-again">üéâ ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫≠‡∫µ‡∫Å‡∫Ñ‡∫±‡ªâ‡∫á</span>
                    </button>
                </div>
            </div>
        </div>


        <!-- JavaScript -->
        <script>
            // --- i18n Translation Object ---
            const i18n = {
                'lo': {
                    ui: {
                        'lang-name': '‡∫•‡∫≤‡∫ß',
                        'welcome-title': '‡ªÄ‡∫Å‡∫° ‡∫Å‡∫¥‡∫ô‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÑ‡∫õ‡∫ô‡∫≠‡∫ô',
                        'welcome-subtitle': '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡ªà‡∫≠‡∫ô‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°',
                        'player-count-label': '‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô:',
                        // 'never-show-again': '‡∫ö‡ªç‡ªà‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫≠‡∫µ‡∫Å‡ªÉ‡∫ô‡∫Ñ‡∫±‡ªâ‡∫á‡∫ï‡ªç‡ªà‡ªÑ‡∫õ (‡∫Å‡∫ª‡∫î Reset ‡∫à‡∫∞‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫≠‡∫µ‡∫Å)', // Removed
                        'save-players': '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÑ‡∫ß‡ªâ‡ªÉ‡∫ä‡ªâ‡∫Ñ‡∫±‡ªâ‡∫á‡ªú‡ªâ‡∫≤', // Added
                        'save-players-note': '(‡∫Å‡∫ª‡∫î \'‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà\' ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫•‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà‡∫ó‡∫µ‡ªà‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÑ‡∫ß‡ªâ)', // Added
                        'start-game': 'üéÆ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°',
                        'nav-rules': 'üìñ ‡∫Å‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤',
                        'nav-settings': '‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤',
                        'cards-remaining': '‡ªÄ‡∫´‡∫º‡∫∑‡∫≠',
                        'cards-unit': '‡ªÉ‡∫ö',
                        'reset-game': 'üîÑ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà',
                        'understood': '‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡ªÉ‡∫à‡ªÅ‡∫•‡ªâ‡∫ß',
                        'all-rules-title': 'üìñ ‡∫Å‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î',
                        'settings-title': '‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤',
                        'customize-rules': '‡∫õ‡∫±‡∫ö‡ªÅ‡∫ï‡ªà‡∫á‡∫Å‡∫ª‡∫î‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤',
                        'reset': '‡∫•‡ªâ‡∫≤‡∫á‡∫Ñ‡ªà‡∫≤',
                        'save': '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å',
                        'close': '‡∫õ‡∫¥‡∫î',
                        'player': '‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô',
                        'player-names-required': '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!',
                        'drink-counter': '‡∫ô‡∫±‡∫ö‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫à‡∫≠‡∫Å',
                        'select-players': '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô:',
                        'cups': '‡∫à‡∫≠‡∫Å',
                        'game-over': '‡ªÄ‡∫Å‡∫°‡∫à‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß!',
                        'summary-subtitle': '‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫î‡∫∑‡ªà‡∫°',
                        'play-again': 'üéâ ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫≠‡∫µ‡∫Å‡∫Ñ‡∫±‡ªâ‡∫á',
                        'dice-drink': 'üçª ‡∫î‡∫∑‡ªà‡∫°!',
                        'dice-safe': 'üòÖ ‡∫•‡∫≠‡∫î!',
                        'roll-dice': 'üé≤ ‡∫™‡∫∏‡ªà‡∫°‡∫•‡∫π‡∫Å‡ªÄ‡∫ï‡∫ª‡ªã‡∫≤',
                        'general-rule-title': 'üìú ‡∫Å‡∫∞‡∫ï‡∫¥‡∫Å‡∫≤‡∫û‡∫∑‡ªâ‡∫ô‡∫ñ‡∫≤‡∫ô:', 
                        'general-rule-fist': '‡∫Å‡∫≥‡∫°‡∫∑‡ªÑ‡∫ß‡ªâ‡∫ï‡∫∞‡∫´‡∫º‡∫≠‡∫î‡ªÄ‡∫Å‡∫°. ‡∫´‡ªâ‡∫≤‡∫°‡ªÉ‡∫´‡ªâ‡∫ô‡∫¥‡ªâ‡∫ß‡∫≠‡∫≠‡∫Å‡∫°‡∫≤, ‡∫ñ‡ªâ‡∫≤‡∫´‡∫º‡∫ª‡∫á‡ªÄ‡∫≠‡∫ª‡∫≤‡∫ô‡∫¥‡ªâ‡∫ß‡∫≠‡∫≠‡∫Å‡∫°‡∫≤‡ªÅ‡∫°‡ªà‡∫ô‡∫î‡∫∑‡ªà‡∫°!, ‡∫Å‡ªç‡∫•‡∫∞‡∫ô‡∫µ‡∫¢‡∫≤‡∫Å‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫´‡ªâ‡∫≠‡∫á‡∫ô‡ªâ‡∫≥ ‡∫ñ‡ªâ‡∫≤ 8 ‡∫ö‡ªç‡ªà‡∫≠‡∫≠‡∫Å ‡ªÅ‡∫°‡ªà‡∫ô ‡∫î‡∫∑‡ªà‡∫°‡∫Å‡ªà‡∫≠‡∫ô 1 ‡∫à‡∫≠‡∫Å ‡∫à‡∫±‡ªà‡∫á‡ªÑ‡∫õ',
                    },
                    rules: { 
                        'A': { name: '‡∫î‡∫∑‡ªà‡∫°‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß', desc: '‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡ªÑ‡∫î‡ªâ‡∫ï‡ªâ‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß 1 ‡∫à‡∫≠‡∫Å.' },
                        '2': { name: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 1 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°‡∫ô‡∫≥‡∫Å‡∫±‡∫ô', desc: '‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 1 ‡∫Ñ‡∫ª‡∫ô ‡ªÉ‡∫´‡ªâ‡∫î‡∫∑‡ªà‡∫°‡∫û‡ªâ‡∫≠‡∫°‡∫Å‡∫±‡∫ô‡∫Å‡∫±‡∫ö‡∫ï‡∫ª‡∫ô‡ªÄ‡∫≠‡∫á (‡∫•‡∫ß‡∫°‡ªÄ‡∫õ‡∫±‡∫ô 2 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°).' },
                        '3': { name: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 2 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°‡∫ô‡∫≥‡∫Å‡∫±‡∫ô', desc: '‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 2 ‡∫Ñ‡∫ª‡∫ô ‡ªÉ‡∫´‡ªâ‡∫î‡∫∑‡ªà‡∫°‡∫û‡ªâ‡∫≠‡∫°‡∫Å‡∫±‡∫ô‡∫Å‡∫±‡∫ö‡∫ï‡∫ª‡∫ô‡ªÄ‡∫≠‡∫á (‡∫•‡∫ß‡∫°‡ªÄ‡∫õ‡∫±‡∫ô 3 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°).' },
                        '4': { name: '‡∫Ñ‡∫ª‡∫ô‡ªÄ‡∫ö‡∫∑‡ªâ‡∫≠‡∫á‡∫ä‡ªâ‡∫≤‡∫ç‡∫î‡∫∑‡ªà‡∫°', desc: '‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà‡∫ô‡∫±‡ªà‡∫á‡ªÄ‡∫ö‡∫∑‡ªâ‡∫≠‡∫á‡∫ä‡ªâ‡∫≤‡∫ç‡∫°‡∫∑‡∫Ç‡∫≠‡∫á‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö ‡∫î‡∫∑‡ªà‡∫° 1 ‡∫à‡∫≠‡∫Å.' },
                        '5': { name: '‡∫î‡∫∑‡ªà‡∫°‡ªù‡∫ª‡∫î‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô', desc: '‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡ªÉ‡∫ô‡∫ß‡∫ª‡∫á‡∫î‡∫∑‡ªà‡∫°‡∫Ñ‡∫ª‡∫ô‡∫•‡∫∞ 1 ‡∫à‡∫≠‡∫Å.' },
                        '6': { name: '‡∫Ñ‡∫ª‡∫ô‡ªÄ‡∫ö‡∫∑‡ªâ‡∫≠‡∫á‡∫Ç‡∫ß‡∫≤‡∫î‡∫∑‡ªà‡∫°', desc: '‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà‡∫ô‡∫±‡ªà‡∫á‡ªÄ‡∫ö‡∫∑‡ªâ‡∫≠‡∫á‡∫Ç‡∫ß‡∫≤‡∫°‡∫∑‡∫Ç‡∫≠‡∫á‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö ‡∫î‡∫∑‡ªà‡∫° 1 ‡∫à‡∫≠‡∫Å.' },
                        '7': { name: '‡∫ï‡∫µ‡∫ä‡∫∏‡ªâ‡∫°‡∫™‡∫≤‡∫°‡∫±‡∫Å‡∫Ñ‡∫µ', desc: '‡∫ú‡∫π‡ªâ‡ªÄ‡∫™‡∫ç‡∫ï‡ªâ‡∫≠‡∫á‡∫ï‡∫¥‡∫î‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡ªù‡∫≤‡∫ç ‡∫°‡∫¥‡∫î‡∫ï‡∫∞‡∫û‡∫≤‡∫ö‡ªÑ‡∫ß‡ªâ ‡∫´‡∫≤‡∫Å‡∫°‡∫µ‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡ªù‡∫≤‡∫ç‡∫ô‡∫µ‡ªâ‡∫î‡∫∑‡ªà‡∫°‡∫ï‡ªâ‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°‡∫ô‡∫≥‡∫Å‡∫±‡∫ô' }, 
                        '8': { name: '‡∫û‡∫±‡∫Å‡∫ú‡ªà‡∫≠‡∫ô', desc: '‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ú‡ªà‡∫≠‡∫ô‡∫Ñ‡∫≤‡∫ç, ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫´‡ªâ‡∫≠‡∫á‡∫ô‡ªâ‡∫≥‡ªÑ‡∫î‡ªâ' },
                        '9': { name: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 1 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°', desc: '‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 1 ‡∫Ñ‡∫ª‡∫ô ‡ªÉ‡∫´‡ªâ‡∫î‡∫∑‡ªà‡∫° 1 ‡∫à‡∫≠‡∫Å (‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫î‡∫∑‡ªà‡∫°).' },
                        '10': { name: '‡ªÄ‡∫Å‡∫°‡∫•‡∫π‡∫Å‡ªÄ‡∫ï‡∫ª‡ªã‡∫≤ (6-12 ‡∫î‡∫∑‡ªà‡∫°)', desc: '‡∫Å‡∫ª‡∫î‡∫™‡∫∏‡ªà‡∫°‡∫•‡∫π‡∫Å‡ªÄ‡∫ï‡∫ª‡ªã‡∫≤. ‡∫ñ‡ªâ‡∫≤‡ªÑ‡∫î‡ªâ 6-12 ‡∫ï‡ªâ‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫° 1 ‡∫à‡∫≠‡∫Å.' },
                        'J': { name: '‡ªÄ‡∫Å‡∫°‡∫•‡∫π‡∫Å‡ªÄ‡∫ï‡∫ª‡ªã‡∫≤ (6-12 ‡∫î‡∫∑‡ªà‡∫°)', desc: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªù‡∫π‡ªà 1 ‡∫Ñ‡∫ª‡∫ô‡∫™‡∫∏‡ªà‡∫°‡∫•‡∫π‡∫Å‡ªÄ‡∫ï‡∫ª‡ªã‡∫≤‡ªÅ‡∫ó‡∫ô. ‡∫ñ‡ªâ‡∫≤‡ªÑ‡∫î‡ªâ 6-12 ‡ªù‡∫π‡ªà‡∫Ñ‡∫ª‡∫ô‡∫ô‡∫±‡ªâ‡∫ô‡∫ï‡ªâ‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°‡∫ô‡∫≥‡∫Å‡∫±‡∫ô.' },
                        'Q': { name: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªù‡∫π‡ªà‡∫≠‡∫µ‡∫Å 2‡∫Ñ‡∫ª‡∫ô‡∫ï‡∫µ‡∫ä‡∫∏‡ªâ‡∫°', desc: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 2 ‡∫Ñ‡∫ª‡∫ô‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡∫π‡ªà‡∫ï‡∫µ‡∫ä‡∫∏‡ªâ‡∫°. ‡∫ñ‡ªâ‡∫≤‡ªÉ‡∫ú‡ªÄ‡∫™‡∫ç‡∫ï‡ªâ‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°.' },
                        'K': { name: '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 2 ‡∫Ñ‡∫ª‡∫ô‡∫î‡∫∑‡ªà‡∫°', desc: '‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å 2 ‡∫Ñ‡∫ª‡∫ô ‡ªÉ‡∫´‡ªâ‡∫î‡∫∑‡ªà‡∫°‡∫Ñ‡∫ª‡∫ô‡∫•‡∫∞ 1 ‡∫à‡∫≠‡∫Å (‡∫ú‡∫π‡ªâ‡∫à‡∫±‡∫ö‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫î‡∫∑‡ªà‡∫°).' }
                    }
                },
                'en': {
                    ui: {
                        'lang-name': 'English',
                        'welcome-title': "King's Cup",
                        'welcome-subtitle': 'Please fill in info to start',
                        'player-count-label': 'Number of Players:',
                        // 'never-show-again': 'Do not show this again (resets on Reset)',
                        'save-players': 'Save player list for next time', // Added
                        'save-players-note': '(Press \'Reset Game\' to clear saved list)', // Added
                        'start-game': 'üéÆ Start Game',
                        'nav-rules': 'üìñ Rules',
                        'nav-settings': '‚öôÔ∏è Settings',
                        'cards-remaining': 'Remaining:',
                        'cards-unit': 'cards',
                        'reset-game': 'üîÑ Reset Game',
                        'understood': 'Got it',
                        'all-rules-title': 'üìñ All Rules',
                        'settings-title': '‚öôÔ∏è Settings',
                        'customize-rules': 'Customize Rules',
                        'reset': 'Reset',
                        'save': 'Save',
                        'close': 'Close',
                        'player': 'Player',
                        'player-names-required': 'Please enter all player names!',
                        'drink-counter': 'Drink Counter',
                        'select-players': 'Select Players:',
                        'cups': 'cups',
                        'game-over': 'Game Over!',
                        'summary-subtitle': 'Final Drink Summary',
                        'play-again': 'üéâ Play Again',
                        'dice-drink': 'üçª Drink!',
                        'dice-safe': 'üòÖ Safe!',
                        'roll-dice': 'üé≤ Roll Dice',
                        'general-rule-title': 'üìú Basic Rule:', 
                        'general-rule-fist': 'Keep your fist closed throughout the game. If you extend your fingers, you drink! If you want to go to the bathroom and card 8 hasn\'t appeared, drink 1 cup first.'
                    },
                    rules: { 
                        'A': { name: 'Waterfall', desc: 'Everyone starts drinking. The person who drew the card stops first.' },
                        '2': { name: 'You', desc: 'Choose one person to drink.' },
                        '3': { name: 'Me', desc: 'You drink.' },
                        '4': { name: 'Floor', desc: 'Last person to touch the floor drinks.' },
                        '5': { name: 'Guys', desc: 'All guys drink.' },
                        '6': { name: 'Chicks', desc: 'All girls drink.' },
                        '7': { name: 'Heaven', desc: 'Last person to point to the sky drinks.' }, 
                        '8': { name: 'Mate', desc: 'Choose a drinking partner. They drink when you drink.' },
                        '9': { name: 'Rhyme', desc: 'Say a word. First to fail to rhyme drinks.' },
                        '10': { name: 'Dice Roll (6-12 Drink)', desc: 'Press Roll Dice. If you get 6 or higher, you drink.' },
                        'J': { name: 'Dice Roll (6-12 Drink)', desc: 'Choose a friend to roll for you. If they get 6 or higher, they drink.' },
                        'Q': { name: 'Choose 2 Partners', desc: 'Choose 2 drinking partners. They drink when you drink.' },
                        'K': { name: 'New Rule', desc: 'Make a new rule. Anyone who breaks it drinks.' }
                    }
                },
                'ja': {
                    ui: {
                        'lang-name': 'Êó•Êú¨Ë™û',
                        'welcome-title': '„Ç≠„É≥„Ç∞„Çπ„Ç´„ÉÉ„Éó',
                        'welcome-subtitle': 'Âßã„ÇÅ„ÇãÂâç„Å´ÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                        'player-count-label': '„Éó„É¨„Ç§„É§„ÉºÊï∞:',
                        // 'never-show-again': 'Ê¨°Âõû„Åã„ÇâË°®Á§∫„Åó„Å™„ÅÑ („É™„Çª„ÉÉ„Éà„ÅßÂÜçË°®Á§∫)',
                        'save-players': '„Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà„ÇíÊ¨°ÂõûÁî®„Å´‰øùÂ≠ò', // Added
                        'save-players-note': '(‰øùÂ≠ò„Åó„Åü„É™„Çπ„Éà„ÇíÊ∂àÂéª„Åô„Çã„Å´„ÅØ„Äå„É™„Çª„ÉÉ„Éà„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ)', // Added
                        'start-game': 'üéÆ „Ç≤„Éº„É†ÈñãÂßã',
                        'nav-rules': 'üìñ „É´„Éº„É´',
                        'nav-settings': '‚öôÔ∏è Ë®≠ÂÆö',
                        'cards-remaining': 'ÊÆã„Çä:',
                        'cards-unit': 'Êûö',
                        'reset-game': 'üîÑ „É™„Çª„ÉÉ„Éà',
                        'understood': '„Çè„Åã„Å£„Åü',
                        'all-rules-title': 'üìñ ÂÖ®„É´„Éº„É´‰∏ÄË¶ß',
                        'settings-title': '‚öôÔ∏è Ë®≠ÂÆö',
                        'customize-rules': '„É´„Éº„É´„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫',
                        'reset': '„É™„Çª„ÉÉ„Éà',
                        'save': '‰øùÂ≠ò',
                        'close': 'Èñâ„Åò„Çã',
                        'player': '„Éó„É¨„Ç§„É§„Éº',
                        'player-names-required': 'ÂÖ®Âì°„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ',
                        'drink-counter': '„Éâ„É™„É≥„ÇØ„Ç´„Ç¶„É≥„Çø„Éº',
                        'select-players': '„Éó„É¨„Ç§„É§„ÉºÈÅ∏Êäû:',
                        'cups': 'ÊùØ',
                        'game-over': '„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ',
                        'summary-subtitle': 'ÊúÄÁµÇÁµêÊûú',
                        'play-again': 'üéâ „ÇÇ„ÅÜ‰∏ÄÂ∫¶',
                        'dice-drink': 'üçª È£≤„ÇÄÔºÅ',
                        'dice-safe': 'üòÖ „Çª„Éº„ÉïÔºÅ',
                        'roll-dice': 'üé≤ „Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Çã',
                        'general-rule-title': 'üìú Âü∫Êú¨„É´„Éº„É´:', 
                        'general-rule-fist': '„Ç≤„Éº„É†‰∏≠„ÅØÊã≥„ÇíÊè°„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊåá„Çí‰º∏„Å∞„Åó„Åü„ÇâÈ£≤„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ„Éà„Ç§„É¨„Å´Ë°å„Åç„Åü„ÅÑÂ†¥Âêà„ÄÅ8„ÅåÂá∫„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„ÄÅ„Åæ„Åö1ÊùØÈ£≤„Çì„Åß„Åã„ÇâË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    rules: { 
                        'A': { name: '„Ç¶„Ç©„Éº„Çø„Éº„Éï„Ç©„Éº„É´', desc: 'ÂÖ®Âì°È£≤„ÅøÂßã„ÇÅ„ÄÅÂºï„ÅÑ„Åü‰∫∫„Åã„ÇâÈ†Ü„Å´È£≤„ÇÄ„ÅÆ„Çí„ÇÑ„ÇÅ„Çã„ÄÇ' },
                        '2': { name: 'ÊåáÂêç', desc: 'Ë™∞„Åã1‰∫∫„ÇíÊåáÂêç„Åó„Å¶È£≤„Åæ„Åõ„Çã„ÄÇ' },
                        '3': { name: 'Ëá™ÂàÜ', desc: 'Ëá™ÂàÜ„ÅåÈ£≤„ÇÄ„ÄÇ' },
                        '4': { name: '„Éï„É≠„Ç¢', desc: 'ÊúÄÂæå„Å´Â∫ä„ÇíËß¶„Å£„Åü‰∫∫„ÅåÈ£≤„ÇÄ„ÄÇ' },
                        '5': { name: 'Áî∑ÊÄß', desc: 'Áî∑ÊÄßÂÖ®Âì°„ÅåÈ£≤„ÇÄ„ÄÇ' },
                        '6': { name: 'Â•≥ÊÄß', desc: 'Â•≥ÊÄßÂÖ®Âì°„ÅåÈ£≤„ÇÄ„ÄÇ' },
                        '7': { name: '„Éò„Éñ„É≥', desc: 'ÊúÄÂæå„Å´Â§©„ÇíÊåá„Åó„Åü‰∫∫„ÅåÈ£≤„ÇÄ„ÄÇ' }, 
                        '8': { name: '„É°„Ç§„Éà', desc: 'È£≤„ÇÄ„Éë„Éº„Éà„Éä„Éº„Çí1‰∫∫ÈÅ∏„Å∂„ÄÇ' },
                        '9': { name: '„É©„Ç§„É†', desc: '„ÅäÈ°å„ÅÆË®ÄËëâ„Å®Èüª„ÇíË∏è„ÇÄË®ÄËëâ„ÇíË®Ä„ÅÜ„ÄÇ' },
                        '10': { name: '„Çµ„Ç§„Ç≥„É≠ (6-12„ÅßÈ£≤„ÇÄ)', desc: '„Äå„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Çã„Äç„ÇíÊäº„Åô„ÄÇ6‰ª•‰∏ä„Å™„ÇâÈ£≤„ÇÄ„ÄÇ' },
                        'J': { name: '„Çµ„Ç§„Ç≥„É≠ (6-12„ÅßÈ£≤„ÇÄ)', desc: 'ÂèãÈÅî„Çí1‰∫∫ÈÅ∏„Çì„ÅßÊåØ„Å£„Å¶„ÇÇ„Çâ„ÅÜ„ÄÇ6‰ª•‰∏ä„Å™„Çâ„Åù„ÅÆÂèãÈÅî„ÅåÈ£≤„ÇÄ„ÄÇ' },
                        'Q': { name: '„Éë„Éº„Éà„Éä„Éº2‰∫∫ÊåáÂêç', desc: 'È£≤„ÇÄ„Éë„Éº„Éà„Éä„Éº„Çí2‰∫∫ÈÅ∏„Å∂„ÄÇ' },
                        'K': { name: 'Êñ∞„É´„Éº„É´', desc: 'Êñ∞„Åó„ÅÑ„É´„Éº„É´„Çí1„Å§‰Ωú„Çã„ÄÇ' }
                    }
                },
                'th': {
                    ui: {
                        'lang-name': '‡πÑ‡∏ó‡∏¢',
                        'welcome-title': '‡∏Ñ‡∏¥‡∏á‡∏™‡πå‡∏Ñ‡∏±‡∏û',
                        'welcome-subtitle': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°',
                        'player-count-label': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:',
                        // 'never-show-again': '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏µ‡∏Å (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà)',
                        'save-players': '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤', // Added
                        'save-players-note': '(‡∏Å‡∏î \'‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï\' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)', // Added
                        'start-game': 'üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°',
                        'nav-rules': 'üìñ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤',
                        'nav-settings': '‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
                        'cards-remaining': '‡πÄ‡∏´‡∏•‡∏∑‡∏≠:',
                        'cards-unit': '‡πÉ‡∏ö',
                        'reset-game': 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï',
                        'understood': '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                        'all-rules-title': 'üìñ ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                        'settings-title': '‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
                        'customize-rules': '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤',
                        'reset': '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï',
                        'save': '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                        'close': '‡∏õ‡∏¥‡∏î',
                        'player': '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
                        'player-names-required': '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô!',
                        'drink-counter': '‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ß',
                        'select-players': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:',
                        'cups': '‡πÅ‡∏Å‡πâ‡∏ß',
                        'game-over': '‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!',
                        'summary-subtitle': '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°',
                        'play-again': 'üéâ ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        'dice-drink': 'üçª ‡∏î‡∏∑‡πà‡∏°!',
                        'dice-safe': 'üòÖ ‡∏£‡∏≠‡∏î!',
                        'roll-dice': 'üé≤ ‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤',
                        'general-rule-title': 'üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:', 
                        'general-rule-fist': '‡∏Å‡∏≥‡∏°‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏Å‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏¢‡∏∑‡πà‡∏ô‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡∏¢‡∏∑‡πà‡∏ô‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°! ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥ ‡∏ñ‡πâ‡∏≤ 8 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô 1 ‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ'
                    },
                    rules: { 
                        'A': { name: '‡∏î‡∏∑‡πà‡∏°‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', desc: '' },
                        '2': { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ñ‡∏ô‡∏î‡∏∑‡πà‡∏°', desc: '' },
                        '3': { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏Ñ‡∏ô‡∏î‡∏∑‡πà‡∏°', desc: '' },
                        '4': { name: '‡∏Ñ‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏î‡∏∑‡πà‡∏°', desc: '' },
                        '5': { name: '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏î‡∏∑‡πà‡∏°', desc: '' },
                        '6': { name: '‡∏Ñ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏î‡∏∑‡πà‡∏°', desc: '' },
                        '7': { name: '‡πÅ‡∏Ç‡πà‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏±‡∏ß‡πÅ‡∏°‡πà‡∏°‡∏∑‡∏≠', desc: '‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' }, 
                        '8': { name: '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', desc: '' },
                        '9': { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏î‡∏∑‡πà‡∏° 1 ‡πÅ‡∏Å‡πâ‡∏ß', desc: '' },
                        '10': { name: '‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤ (6-12 ‡∏î‡∏∑‡πà‡∏°)', desc: '‡∏Å‡∏î "‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤". ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ 6 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡∏î‡∏∑‡πà‡∏°' },
                        'J': { name: '‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤ (6-12 ‡∏î‡∏∑‡πà‡∏°)', desc: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô 1 ‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤‡πÅ‡∏ó‡∏ô. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ 6 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏î‡∏∑‡πà‡∏°' },
                        'Q': { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏î‡∏∑‡πà‡∏° 2 ‡∏Ñ‡∏ô', desc: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô 2 ‡∏Ñ‡∏ô. ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏î‡∏∑‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' },
                        'K': { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏Ñ‡∏ô‡∏î‡∏∑‡πà‡∏°', desc: '' }
                    }
                }
            };

            let currentLanguage = localStorage.getItem('kingscup-language') || 'lo';

            function t(key) {
                return i18n[currentLanguage].ui[key] || key;
            }

            function setLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('kingscup-language', lang);
                
                // Update all UI elements with data-i18n attribute
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (i18n[lang] && i18n[lang].ui[key]) {
                        el.textContent = i18n[lang].ui[key];
                    }
                });
                
                // Update current language display
                document.getElementById('current-lang').textContent = i18n[lang].ui['lang-name'];
                document.documentElement.lang = lang;

                // Update rules with current language
                loadDefaultRulesForLanguage(lang);
                // Update settings modal inputs
                populateSettingsInputs();
            }

            function loadDefaultRulesForLanguage(lang) {
                // Only update if user hasn't customized rules
                const hasCustomRules = localStorage.getItem('kingscup-rules');
                if (!hasCustomRules) {
                    rules = JSON.parse(JSON.stringify(i18n[lang].rules));
                }
            }

            // Data
            const suits = ['‚ô•','‚ô¶','‚ô£','‚ô†'];
            const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

            // --- LOAD CUSTOM RULES FROM LOCALSTORAGE ---
            let rules = JSON.parse(JSON.stringify(i18n[currentLanguage].rules));
            function loadRules() {
                const saved = localStorage.getItem('kingscup-rules');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Migrate old format to new format
                        ranks.forEach(rank => {
                            if (typeof parsed[rank] === 'string') {
                                rules[rank] = { name: parsed[rank], desc: '' };
                            } else if (parsed[rank]) {
                                rules[rank] = parsed[rank];
                            }
                        });
                    } catch (e) {
                        rules = JSON.parse(JSON.stringify(i18n[currentLanguage].rules));
                    }
                } else {
                    // Load default rules for current language
                    rules = JSON.parse(JSON.stringify(i18n[currentLanguage].rules));
                }
            }
            loadRules();

            // Elements
            const cardEl = document.getElementById('card');
            const cardClickableArea = document.getElementById('card-clickable-area');
            
            // Card Face Elements
            const rankTop = document.getElementById('rank-top');
            const suitTop = document.getElementById('suit-top');
            const rankBottom = document.getElementById('rank-bottom');
            const suitBottom = document.getElementById('suit-bottom');
            const centerSuit = document.getElementById('center-suit');

            // --- MODAL ELEMENTS ---
            const ruleModal = document.getElementById('rule-modal');
            const modalContent = document.getElementById('modal-content');
            // Standard Card
            const modalCard = document.getElementById('modal-card');
            const modalRank = document.getElementById('modal-rank');
            const modalSuit = document.getElementById('modal-suit');
            // Dice Roll
            const modalDiceUI = document.getElementById('modal-dice-ui');
            const modalDiceRoll = document.getElementById('modal-dice-roll');
            const diceResultNumber = document.getElementById('dice-result-number');
            const diceResultText = document.getElementById('dice-result-text');
            const modalRollDiceBtn = document.getElementById('modal-roll-dice-btn');
            // Rule Text
            const modalRuleText = document.getElementById('modal-rule-text');
            const modalRuleDesc = document.getElementById('modal-rule-desc');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- NEW ELEMENTS ---
            const cardsRemainingEl = document.getElementById('cards-remaining');
            const resetBtn = document.getElementById('reset-btn');
            const rulesBtn = document.getElementById('rules-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const rulesModal = document.getElementById('rules-modal');
            const rulesModalContent = document.getElementById('rules-modal-content');
            const rulesModalCloseBtn = document.getElementById('rules-modal-close-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsModalContent = document.getElementById('settings-modal-content');
            const settingsRulesList = document.getElementById('settings-rules-list');
            const settingsModalCloseBtn = document.getElementById('settings-modal-close-btn');
            const saveRulesBtn = document.getElementById('save-rules-btn');
            const resetRulesBtn = document.getElementById('reset-rules-btn');
            
            // Welcome modal elements
            const welcomeModal = document.getElementById('welcome-modal');
            const welcomeModalContent = document.getElementById('welcome-modal-content');
            const playerCountInput = document.getElementById('player-count');
            const playerNamesContainer = document.getElementById('player-names-container');
            const decreasePlayersBtn = document.getElementById('decrease-players');
            const increasePlayersBtn = document.getElementById('increase-players');
            const startGameBtn = document.getElementById('start-game-btn');
            const savePlayersCheckbox = document.getElementById('save-players-checkbox'); // Updated ID

            // Player elements
            const playersSection = document.getElementById('players-section');
            const playersContainer = document.getElementById('players-container');

            // Summary Modal elements
            const summaryModal = document.getElementById('summary-modal');
            const summaryModalCloseBtn = document.getElementById('summary-modal-close-btn');
            
            // Language elements
            const langBtn = document.getElementById('lang-btn');
            const langDropdown = langBtn.closest('.lang-dropdown');
            const langOptions = document.querySelectorAll('.lang-dropdown-menu button');


            let deck = [];
            let players = [];
            let playerDrinkCounts = {}; // Track drink counts
            let playerColors = {}; // Store player colors
            let playerPartners = { selected: [] }; // Store partners for card 7
            let gameStarted = false;
            let isResetAction = false;
            let touchStartTime = 0; // Variable to track touch start time for long press

            function updateCardsRemaining() {
                cardsRemainingEl.textContent = deck.length;
            }

            function createDeck(){
                deck = [];
                for(const s of suits){
                    for(const r of ranks){
                        deck.push({rank:r,suit:s});
                    }
                }
                updateCardsRemaining();
            }

            function shuffle(){
                for(let i=deck.length-1;i>0;i--){
                    const j=Math.floor(Math.random()*(i+1));
                    [deck[i],deck[j]]=[deck[j],deck[i]];
                }
            }

            function applyCardToFace(card){
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                const suitClass = isRed ? 'suit-red' : 'suit-black';
                
                // Set content
                rankTop.textContent = card.rank;
                suitTop.textContent = card.suit;
                rankBottom.textContent = card.rank;
                suitBottom.textContent = card.suit;
                centerSuit.textContent = card.suit;
                
                // Set colors based on suit
                rankTop.className = `text-2xl font-extrabold ${suitClass}`;
                suitTop.className = `text-xl ${suitClass}`;
                rankBottom.className = `text-2xl font-extrabold ${suitClass}`;
                suitBottom.className = `text-xl ${suitClass}`;
                centerSuit.className = `text-8xl font-extrabold ${suitClass}`;
            }

            // --- MODAL FUNCTIONS ---
            function showModal(card, rule) {
                const isRed = card.suit === '‚ô•' || card.suit === '‚ô¶';
                const suitClass = isRed ? 'suit-red' : 'suit-black';

                // Reset all modal parts
                modalCard.classList.add('hidden');
                modalDiceUI.classList.add('hidden');
                diceResultText.classList.add('hidden');
                modalRollDiceBtn.classList.add('hidden');
                modalCloseBtn.classList.remove('hidden'); // Show close btn by default

                // Standard rule text
                modalRuleText.textContent = rule.name;
                modalRuleDesc.textContent = rule.desc || '';

                // --- Special Dice Roll Logic for 10 and J ---
                if (card.rank === '10' || card.rank === 'J') {
                    // Show dice roll UI
                    modalDiceUI.classList.remove('hidden');
                    diceResultNumber.textContent = '?'; // Reset dice number
                    diceResultNumber.className = 'text-6xl font-extrabold'; // Reset color
                    modalRollDiceBtn.classList.remove('hidden'); // Show roll button
                    modalCloseBtn.classList.add('hidden'); // Hide close button

                } else if (card.rank === '8') {
                    // Show custom countdown UI for 8
                    // Remove any previous custom content
                    let customCountdown = document.getElementById('modal-countdown-ui');
                    if (customCountdown) customCountdown.remove();

                    // Create countdown UI
                    customCountdown = document.createElement('div');
                    customCountdown.id = 'modal-countdown-ui';
                    customCountdown.className = 'flex flex-col items-center gap-4 mb-4';
                    customCountdown.innerHTML = `
                        <div class="text-6xl mb-2">‚è≥</div>
                        <div class="flex flex-col items-center gap-2 w-full">
                            <label class="text-base font-semibold mb-1" for="countdown-min">‡∫Å‡∫≥‡∫ô‡∫ª‡∫î‡ªÄ‡∫ß‡∫•‡∫≤‡∫ô‡∫±‡∫ö‡∫ñ‡∫≠‡∫ç‡∫´‡∫º‡∫±‡∫á</label>
                            <div class="flex flex-col gap-2 w-full">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="w-14 text-center text-lg font-semibold">‡∫ô‡∫≤‡∫ó‡∫µ</span>
                                    <button type="button" id="min-sub" class="w-8 h-8 rounded-full bg-amber-200 hover:bg-amber-300 text-xl font-bold flex items-center justify-center">-</button>
                                    <input id="countdown-min" type="number" min="0" max="59" value="2" class="w-16 text-center px-2 py-2 border-2 border-amber-400 focus:border-amber-500 rounded-lg text-xl font-bold transition-all" />
                                    <button type="button" id="min-add" class="w-8 h-8 rounded-full bg-amber-200 hover:bg-amber-300 text-xl font-bold flex items-center justify-center">+</button>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <span class="w-14 text-center text-lg font-semibold">‡∫ß‡∫¥‡∫ô‡∫≤‡∫ó‡∫µ</span>
                                    <button type="button" id="sec-sub" class="w-8 h-8 rounded-full bg-amber-200 hover:bg-amber-300 text-xl font-bold flex items-center justify-center">-</button>
                                    <input id="countdown-sec" type="number" min="1" max="59" value="0" class="w-16 text-center px-2 py-2 border-2 border-amber-400 focus:border-amber-500 rounded-lg text-xl font-bold transition-all" />
                                    <button type="button" id="sec-add" class="w-8 h-8 rounded-full bg-amber-200 hover:bg-amber-300 text-xl font-bold flex items-center justify-center">+</button>
                                </div>
                            </div>
                        </div>
                        <button id="start-countdown-btn" class="w-full mt-4 px-6 py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-lg font-bold shadow-lg transition-all active:scale-95">‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫à‡∫±‡∫ö‡ªÄ‡∫ß‡∫•‡∫≤</button>
                        <button id="skip-countdown-btn" class="w-full px-6 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 text-base font-semibold shadow transition-all active:scale-95 mt-2">‚è≠Ô∏è ‡∫Ç‡ªâ‡∫≤‡∫°‡ªÄ‡∫ß‡∫•‡∫≤</button>
                        <div id="countdown-timer" class="text-5xl font-extrabold mt-6 mb-2 hidden text-blue-600"></div>
                        <div id="countdown-done" class="text-3xl font-bold mt-2 hidden text-green-600">‚è∞ ‡ªù‡∫ª‡∫î‡ªÄ‡∫ß‡∫•‡∫≤!</div>
                    `;
                    // Insert before close button
                    modalContent.insertBefore(customCountdown, modalCloseBtn);
                    modalCloseBtn.classList.add('hidden');

                    // Add event listeners for countdown UI
                    const startBtn = customCountdown.querySelector('#start-countdown-btn');
                    const skipBtn = customCountdown.querySelector('#skip-countdown-btn');
                    const minInput = customCountdown.querySelector('#countdown-min');
                    const secInput = customCountdown.querySelector('#countdown-sec');
                    const timerDisplay = customCountdown.querySelector('#countdown-timer');
                    const doneDisplay = customCountdown.querySelector('#countdown-done');
                    let countdownInterval = null;

                    // Stepper buttons
                    customCountdown.querySelector('#min-add').onclick = () => {
                        let val = parseInt(minInput.value) || 0;
                        if (val < 59) minInput.value = val + 1;
                        minInput.dispatchEvent(new Event('input'));
                    };
                    customCountdown.querySelector('#min-sub').onclick = () => {
                        let val = parseInt(minInput.value) || 0;
                        if (val > 0) minInput.value = val - 1;
                        minInput.dispatchEvent(new Event('input'));
                    };
                    customCountdown.querySelector('#sec-add').onclick = () => {
                        let val = parseInt(secInput.value) || 0;
                        if (val < 59) secInput.value = val + 1;
                        secInput.dispatchEvent(new Event('input'));
                    };
                    customCountdown.querySelector('#sec-sub').onclick = () => {
                        let val = parseInt(secInput.value) || 1;
                        if (val > 1) secInput.value = val - 1;
                        secInput.dispatchEvent(new Event('input'));
                    };

                    // Input validation
                    minInput.oninput = function() {
                        let val = parseInt(minInput.value) || 0;
                        if (val < 0) minInput.value = 0;
                        if (val > 59) minInput.value = 59;
                    };
                    secInput.oninput = function() {
                        let val = parseInt(secInput.value) || 1;
                        if (val < 1) secInput.value = 1;
                        if (val > 59) secInput.value = 59;
                    };

                    function finishCountdown() {
                        if (countdownInterval) clearInterval(countdownInterval);
                        timerDisplay.classList.add('hidden');
                        doneDisplay.classList.remove('hidden');
                        setTimeout(() => {
                            modalCloseBtn.classList.remove('hidden');
                        }, 700);
                    }

                    startBtn.onclick = function() {
                        let min = parseInt(minInput.value) || 0;
                        let sec = parseInt(secInput.value) || 1;
                        let totalSeconds = min * 60 + sec;
                        if (totalSeconds < 1) totalSeconds = 1;
                        minInput.disabled = true;
                        secInput.disabled = true;
                        startBtn.disabled = true;
                        skipBtn.disabled = true;
                        timerDisplay.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                        timerDisplay.classList.remove('hidden');
                        doneDisplay.classList.add('hidden');
                        countdownInterval = setInterval(() => {
                            totalSeconds--;
                            let m = Math.floor(totalSeconds / 60);
                            let s = totalSeconds % 60;
                            timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                            if (totalSeconds <= 0) {
                                finishCountdown();
                            }
                        }, 1000);
                    };
                    skipBtn.onclick = function() {
                        minInput.disabled = true;
                        secInput.disabled = true;
                        startBtn.disabled = true;
                        skipBtn.disabled = true;
                        finishCountdown();
                    };

                } else if (card.rank === '7') {
                    // Show partner selection UI for 7
                    let partnerUI = document.getElementById('modal-partner-ui');
                    if (partnerUI) partnerUI.remove();

                    partnerUI = document.createElement('div');
                    partnerUI.id = 'modal-partner-ui';
                    partnerUI.className = 'flex flex-col items-center gap-4 mb-4';
                    partnerUI.innerHTML = `
                        <div class="text-6xl mb-2">ü§ù</div>
                        <div class="text-base font-semibold mb-1">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫û‡∫≤‡∫Å‡∫Æ‡ªà‡∫ß‡∫° <span id='partner-count' class='text-amber-600'>(0/4)</span></div>
                        <div id="partner-list" class="flex flex-wrap gap-2 justify-center mb-2"></div>
                        <div class="text-sm text-slate-500">‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫õ‡ªà‡∫Ω‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡ªÑ‡∫î‡ªâ‡ªÉ‡∫ô‡∫Ñ‡∫±‡ªâ‡∫á‡∫ï‡ªç‡ªà‡ªÑ‡∫õ</div>
                        <button id="save-partners-btn" class="w-full mt-2 px-6 py-3 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-lg font-bold shadow-lg transition-all active:scale-95 opacity-50 cursor-not-allowed" disabled>‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫Æ‡ªà‡∫ß‡∫°</button>
                    `;
                    modalContent.insertBefore(partnerUI, modalCloseBtn);
                    modalCloseBtn.classList.add('hidden');

                    // Render player selection chips
                    const partnerList = partnerUI.querySelector('#partner-list');
                    partnerList.innerHTML = players.map((player, idx) => {
                        const color = playerColors[player] || '#f59e42';
                        const initials = player.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
                        return `
                            <button type="button" class="partner-chip flex items-center gap-2 px-3 py-2 rounded-full border-2 border-amber-300 bg-white text-slate-800 font-semibold shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-amber-400" data-player="${player}" style="border-color:${color};">
                                <span class="w-7 h-7 flex items-center justify-center rounded-full text-white font-bold text-base" style="background:${color}">${initials}</span>
                                <span>${player}</span>
                            </button>
                        `;
                    }).join('');

                    // Pre-select previous partners if any
                    let selected = [];
                    if (playerPartners.selected && Array.isArray(playerPartners.selected)) {
                        selected = playerPartners.selected.slice();
                    }
                    // Highlight selected chips
                    function updateChips() {
                        partnerList.querySelectorAll('.partner-chip').forEach(btn => {
                            const p = btn.getAttribute('data-player');
                            if (selected.includes(p)) {
                                btn.classList.add('ring-4','ring-amber-300','bg-amber-100');
                            } else {
                                btn.classList.remove('ring-4','ring-amber-300','bg-amber-100');
                            }
                        });
                        partnerUI.querySelector('#partner-count').textContent = `(${selected.length}/4)`;
                        // Enable save if valid
                        const saveBtn = partnerUI.querySelector('#save-partners-btn');
                        if (selected.length > 0 && selected.length <= 4) {
                            saveBtn.disabled = false;
                            saveBtn.classList.remove('opacity-50','cursor-not-allowed');
                        } else {
                            saveBtn.disabled = true;
                            saveBtn.classList.add('opacity-50','cursor-not-allowed');
                        }
                    }
                    updateChips();
                    // Chip click logic
                    partnerList.querySelectorAll('.partner-chip').forEach(btn => {
                        btn.onclick = function() {
                            const p = btn.getAttribute('data-player');
                            if (selected.includes(p)) {
                                selected = selected.filter(x => x !== p);
                            } else if (selected.length < 4) {
                                selected.push(p);
                            }
                            updateChips();
                        };
                    });
                    // Save partners button logic
                    partnerUI.querySelector('#save-partners-btn').onclick = function() {
                        if (selected.length === 0 || selected.length > 4) return;
                        playerPartners.selected = selected.slice();
                        modalCloseBtn.classList.remove('hidden');
                        partnerUI.querySelector('#save-partners-btn').disabled = true;
                        partnerUI.querySelector('#save-partners-btn').classList.add('opacity-50','cursor-not-allowed');
                    };
                } else {
                    // Show standard card UI
                    modalCard.classList.remove('hidden');
                    modalRank.textContent = card.rank;
                    modalSuit.textContent = card.suit;
                    modalRank.className = `text-4xl font-extrabold ${suitClass}`;
                    modalSuit.className = `text-3xl ${suitClass}`;
                }

                ruleModal.classList.remove('invisible');
                setTimeout(() => {
                    ruleModal.classList.add('visible');
                }, 10);
            }

            function handleDiceRoll() {
                const roll = Math.floor(Math.random() * 11) + 2; // Random 2-12
                diceResultNumber.textContent = roll;
                diceResultText.classList.remove('hidden');

                if (roll >= 6) {
                    diceResultText.textContent = t('dice-drink');
                    diceResultText.className = 'text-3xl font-bold mb-6 text-red-600';
                    diceResultNumber.className = 'text-6xl font-extrabold text-red-600';
                } else {
                    diceResultText.textContent = t('dice-safe');
                    diceResultText.className = 'text-3xl font-bold mb-6 text-green-600';
                    diceResultNumber.className = 'text-6xl font-extrabold text-green-600';
                }
                
                // Hide roll button, show close button
                modalRollDiceBtn.classList.add('hidden');
                modalCloseBtn.classList.remove('hidden');
            }

            function hideModal() {
                // Remove countdown UI if present (for card 8)
                const customCountdown = document.getElementById('modal-countdown-ui');
                if (customCountdown) customCountdown.remove();
                // Remove partner UI if present (for card 7)
                const partnerUI = document.getElementById('modal-partner-ui');
                if (partnerUI) partnerUI.remove();

                ruleModal.classList.remove('visible');
                setTimeout(() => {
                    ruleModal.classList.add('invisible');
                }, 300); // Match transition duration

                // Flip card back so next card can be drawn
                cardEl.classList.add('flipped');
            }

            function showRulesModal() {
                // Add the general rule first
                const generalRuleHtml = `
                    <div class="bg-amber-100 rounded-lg p-4 border border-amber-300">
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-12 h-12 bg-amber-200 rounded-lg flex items-center justify-center shadow-sm">
                                <span class="font-bold text-xl text-amber-700">üìú</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-amber-900 mb-1" data-i18n="general-rule-title">${t('general-rule-title')}</div>
                                <div class="text-sm text-amber-800 leading-relaxed" data-i18n="general-rule-fist">${t('general-rule-fist')}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Update rules modal with current card rules
                const cardRulesHtml = ranks.map((rank, idx) => {
                    const isRed = idx % 2 === 0;
                    const suitClass = isRed ? 'suit-red' : 'suit-black';
                    const suit = isRed ? '‚ô•' : '‚ô†';
                    const rule = rules[rank];
                    return `
                        <div class="bg-slate-50 rounded-lg p-4 hover:bg-slate-100 transition-colors">
                            <div class="flex gap-3 items-start">
                                <div class="flex-shrink-0 w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                    <span class="font-bold text-xl ${suitClass}">${rank}${suit}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-slate-900 mb-1">${rule.name}</div>
                                    ${rule.desc ? `<div class="text-sm text-slate-600 leading-relaxed">${rule.desc}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Combine general rule and card rules
                document.getElementById('rules-list').innerHTML = generalRuleHtml + cardRulesHtml;
                
                rulesModal.classList.remove('invisible');
                setTimeout(() => {
                    rulesModal.classList.add('visible');
                }, 10);
            }

            function hideRulesModal() {
                rulesModal.classList.remove('visible');
                setTimeout(() => {
                    rulesModal.classList.add('invisible');
                }, 300);
            }

           

            // --- Populates settings inputs ---
            function populateSettingsInputs() {
                settingsRulesList.innerHTML = ranks.map((rank, idx) => {
                    const isRed = idx % 2 === 0;
                    const suitClass = isRed ? 'suit-red' : 'suit-black';
                    const suit = isRed ? '‚ô•' : '‚ô†';
                    const rule = rules[rank];
                    return `
                        <div class="bg-slate-50 rounded-lg p-4">
                            <label class="flex gap-3 items-center mb-3">
                                <span class="font-bold text-xl ${suitClass} w-10">${rank}${suit}</span>
                                <input type="text" id="rule-${rank}" value="${rule.name}" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 font-semibold" placeholder="Rule Name">
                            </label>
                            <textarea id="desc-${rank}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm" rows="2" placeholder="Description (optional)">${rule.desc || ''}</textarea>
                        </div>
                    `;
                }).join('');
            }

            function showSettingsModal() {
                populateSettingsInputs();
                settingsModal.classList.remove('invisible');
                setTimeout(() => {
                    settingsModal.classList.add('visible');
                }, 10);
            }

            function hideSettingsModal() {
                settingsModal.classList.remove('visible');
                setTimeout(() => {
                    settingsModal.classList.add('invisible');
                }, 300);
            }

            // --- WELCOME MODAL FUNCTIONS ---
            function updatePlayerCount(delta) {
                const current = parseInt(playerCountInput.value) || 4;
                const newValue = Math.max(1, Math.min(20, current + delta));
                playerCountInput.value = newValue;
                generatePlayerInputs(true); // Regenerate inputs with empty values, don't use saved names when changing count
            }

            function generatePlayerInputs(clearValues = false) {
                const count = parseInt(playerCountInput.value) || 1;
                const playerText = t('player');
                playerNamesContainer.innerHTML = '';
                const savedNames = loadPlayerNames(); // Load saved names

                // Determine if we should pre-fill based on checkbox state and saved names existence
                const shouldPreFill = savePlayersCheckbox.checked && savedNames && !clearValues;

                for (let i = 1; i <= count; i++) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    // Use saved name only if pre-filling and index is within saved names array bounds
                    const preFilledName = (shouldPreFill && i - 1 < savedNames.length) ? savedNames[i-1] : ''; 
                    div.innerHTML = `
                        <span class="font-semibold text-slate-600 w-12">#${i}</span>
                        <input type="text" id="player-${i}" placeholder="${playerText} ${i}" value="${preFilledName}" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                    `;
                    playerNamesContainer.appendChild(div);
                }
            }
            
             // --- Function to save player names ---
            function savePlayerNames(names) {
                localStorage.setItem('kingscup-player-names', JSON.stringify(names));
            }

            // --- Function to load player names ---
            function loadPlayerNames() {
                const saved = localStorage.getItem('kingscup-player-names');
                try {
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null; // Handle potential parsing errors
                }
            }

            // --- Modified showWelcomeModal ---
            function showWelcomeModal() {
                const savedNames = loadPlayerNames();
                if (savedNames) {
                    playerCountInput.value = savedNames.length; // Set count based on saved names
                    savePlayersCheckbox.checked = true; // Check the box if names were loaded
                } else {
                    savePlayersCheckbox.checked = false; // Uncheck if no names saved
                }
                generatePlayerInputs(); // Generate inputs (will use saved names if available and box is checked)
                welcomeModal.classList.remove('invisible');
                setTimeout(() => {
                    welcomeModal.classList.add('visible');
                }, 10);
            }


            function hideWelcomeModal() {
                welcomeModal.classList.remove('visible');
                setTimeout(() => {
                    welcomeModal.classList.add('invisible');
                }, 300);
            }

            // --- Modified startGame ---
            function startGame() {
                const count = parseInt(playerCountInput.value) || 1;
                players = [];
                
                // Collect player names
                let currentNames = []; // Array to store current names before saving/removing
                for (let i = 1; i <= count; i++) {
                    const input = document.getElementById(`player-${i}`);
                    const name = input ? input.value.trim() : '';
                    if (!name) {
                        alert(t('player-names-required'));
                        return;
                    }
                    players.push(name);
                    currentNames.push(name); // Add to current names array
                }
                
                // Save or remove player names based on checkbox
                if (savePlayersCheckbox.checked) {
                    savePlayerNames(currentNames); // Save the entered names
                } else {
                    localStorage.removeItem('kingscup-player-names'); // Remove saved names if unchecked
                }

                // Initialize drink counts and colors
                playerDrinkCounts = {};
                playerColors = {};
                const colors = ['#ef4444', '#f97316', '#84cc16', '#10b981', '#06b6d4', '#6366f1', '#d946ef', '#f43f5e'];
                players.forEach((player, index) => {
                    playerDrinkCounts[player] = 0;
                    playerColors[player] = colors[index % colors.length];
                });
                
                gameStarted = true;
                hideWelcomeModal();
                renderPlayerButtons();
                playersSection.classList.remove('hidden');
            }


            // --- Modified renderPlayerButtons ---
            function renderPlayerButtons() {
                const cupsText = t('cups');
                playersContainer.innerHTML = players.map(player => `
                    <button class="player-btn px-4 py-3 text-white rounded-lg font-semibold transition-all active:scale-95" data-player="${player}" style="background-color: ${playerColors[player]}">
                        <div class="text-sm mb-1 flex items-center justify-center gap-1">
                            ${player}
                            ${(playerPartners.selected && Array.isArray(playerPartners.selected) && playerPartners.selected.includes(player)) ? '<span title="Partner" class="ml-1">ü§ù</span>' : ''}
                        </div>
                        <div class="text-xl font-bold">${playerDrinkCounts[player]} ${cupsText}</div>
                    </button>
                `).join('');

                // Add improved click and long-press listeners
                document.querySelectorAll('.player-btn').forEach(btn => {
                    const player = btn.getAttribute('data-player');
                    let pressTimer = null;
                    let startTime = 0;
                    const longPressDuration = 2000; // 2 seconds

                    const handlePressStart = (e) => {
                        if (!btn.contains(e.target)) return; 
                        e.preventDefault();
                        startTime = Date.now();
                        clearTimeout(pressTimer); 
                        pressTimer = setTimeout(() => {
                            // Long press detected
                            if (playerDrinkCounts[player] > 0) {
                                playerDrinkCounts[player]--;
                                renderPlayerButtons(); // Update UI
                            }
                            pressTimer = null;
                            startTime = 0;
                        }, longPressDuration);
                    };

                    const handlePressEnd = (e) => {
                        if (!btn.contains(e.target) && e.type !== 'touchend' && e.type !== 'touchcancel') return;
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                            if (startTime > 0 && duration < 500) {
                                // Tap: increment drink count for player and partners
                                playerDrinkCounts[player] = (playerDrinkCounts[player] || 0) + 1;
                                // Only if the clicked player is in the partner list, increment the other partners
                                if (playerPartners.selected && Array.isArray(playerPartners.selected) && playerPartners.selected.includes(player)) {
                                    playerPartners.selected.forEach(partner => {
                                        if (partner !== player && playerDrinkCounts[partner] !== undefined) {
                                            playerDrinkCounts[partner] = (playerDrinkCounts[partner] || 0) + 1;
                                        }
                                    });
                                }
                                renderPlayerButtons();
                            }
                        }
                        startTime = 0;
                    };

                    // Mouse events
                    btn.addEventListener('mousedown', handlePressStart);
                    btn.addEventListener('mouseup', handlePressEnd);
                    btn.addEventListener('mouseleave', () => { // Cancel timer if mouse leaves
                         if (pressTimer) {
                             clearTimeout(pressTimer);
                             pressTimer = null;
                         }
                         startTime = 0; // Reset start time if mouse leaves
                    }); 

                    // Touch events
                    btn.addEventListener('touchstart', handlePressStart, { passive: false });
                    btn.addEventListener('touchend', handlePressEnd);
                    btn.addEventListener('touchcancel', () => { // Cancel timer if touch is cancelled
                         if (pressTimer) {
                             clearTimeout(pressTimer);
                             pressTimer = null;
                         }
                         startTime = 0; // Reset start time on cancel
                    });
                     // Removed the separate click listener as handlePressEnd now manages taps
                });
            }


            // --- UPDATED DRAW CARD LOGIC ---

            function drawCard(){
                if (!cardEl.classList.contains('flipped')) {
                    return; // Don't draw if card is already face up or animating
                }

                if (deck.length === 0) {
                    showSummaryModal();
                    return;
                }

                const card = deck.pop();
                updateCardsRemaining();
                const rule = rules[card.rank];

                // --- Everyone drinks if 5 is drawn ---
                if (card.rank === '5') {
                    players.forEach(player => {
                        playerDrinkCounts[player] = (playerDrinkCounts[player] || 0) + 1;
                    });
                    renderPlayerButtons(); // Update UI
                }

                applyCardToFace(card);

                cardEl.classList.remove('flipped'); // Start flip animation to front

                // Show modal slightly after animation starts
                setTimeout(() => {
                    showModal(card, rule);
                }, 700); // Wait for flip animation + small delay
            }

             // --- New function to restart the game without clearing names ---
            function restartGame() {
                hideSummaryModal(); // Hide the summary modal first

                gameStarted = true; // Make sure game state is active
                
                // Reset deck
                createDeck();
                shuffle();
                cardEl.classList.add('flipped'); // Ensure card starts flipped

                // Reset drink counts (keeping players and colors)
                players.forEach(player => {
                    playerDrinkCounts[player] = 0;
                });
                renderPlayerButtons(); // Re-render buttons with zero counts
                playersSection.classList.remove('hidden'); // Ensure section is visible

                // Reset card face display after animation potentially finishes
                setTimeout(() => {
                    centerSuit.textContent = 'üëë'; 
                    rankTop.textContent=''; 
                    rankBottom.textContent=''; 
                    suitTop.textContent=''; 
                    suitBottom.textContent='';
                    centerSuit.className = 'text-8xl font-extrabold suit-red';
                }, 600); 

                // Clear partner list
                playerPartners.selected = [];
            }

            // --- Modified handleReset ---
            function handleReset() {
                // Show welcome modal again to restart AND CLEAR NAMES
                gameStarted = false;
                players = [];
                playerDrinkCounts = {};
                playerColors = {};
                localStorage.removeItem('kingscup-player-names'); // Clear saved names is the key part of reset
                savePlayersCheckbox.checked = false; // Uncheck the save box
                isResetAction = true;
                playersSection.classList.add('hidden');
                
                playerCountInput.value = 4; // Reset to default count for the modal
                showWelcomeModal(); // Show modal, it will now generate empty inputs because names were cleared
                
                createDeck();
                shuffle();
                cardEl.classList.add('flipped'); // Ensure card starts flipped
                
                // Reset card face display after animation potentially finishes
                setTimeout(() => {
                    centerSuit.textContent = 'üëë'; 
                    rankTop.textContent=''; 
                    rankBottom.textContent=''; 
                    suitTop.textContent=''; 
                    suitBottom.textContent='';
                    centerSuit.className = 'text-8xl font-extrabold suit-red';
                }, 600); // Match card animation duration

                // Clear partner list
                playerPartners.selected = [];
            }


            // --- SUMMARY MODAL FUNCTIONS ---
            function showSummaryModal() {
                // Ensure player data exists before sorting
                if (!players || players.length === 0 || !playerDrinkCounts) {
                    console.error("No player data available for summary.");
                    handleReset(); // Go back to setup if data is missing
                    return;
                }

                const sortedPlayers = Object.entries(playerDrinkCounts)
                    .filter(([player]) => players.includes(player)) // Ensure only current players are included
                    .sort(([, a], [, b]) => b - a);
                
                const summaryList = document.getElementById('summary-list');
                const cupsText = t('cups');
                const medals = ['ü•á', 'ü•à', 'ü•â'];

                summaryList.innerHTML = sortedPlayers.map(([player, count], index) => `
                    <div class="flex items-center gap-4 p-3 rounded-lg" style="background-color: ${playerColors[player]}1A;">
                        <div class="text-2xl w-8 text-center">${medals[index] || ' '}</div>
                        <div class="flex-1 font-bold text-slate-800">${player}</div>
                        <div class="font-bold text-lg text-slate-900">${count} ${cupsText}</div>
                    </div>
                `).join('');

                summaryModal.classList.remove('invisible');
                setTimeout(() => summaryModal.classList.add('visible'), 10);
            }


            function hideSummaryModal() {
                summaryModal.classList.remove('visible');
                setTimeout(() => summaryModal.classList.add('invisible'), 300);
            }

            // --- SETTINGS FUNCTIONS ---
            function saveCustomRules() {
                // Save rules from inputs
                ranks.forEach(rank => {
                    const ruleInput = document.getElementById(`rule-${rank}`);
                    const descInput = document.getElementById(`desc-${rank}`);
                    if (ruleInput) {
                        rules[rank].name = ruleInput.value.trim() || rules[rank].name;
                    }
                    if (descInput) {
                        rules[rank].desc = descInput.value.trim();
                    }
                });
                
                // Save to localStorage
                localStorage.setItem('kingscup-rules', JSON.stringify(rules));
                
                // Show confirmation
                alert(`‚úÖ ${t('save')}!`);
                hideSettingsModal();
            }

            function resetToDefaultRules() {
                if (confirm(`${t('reset')}?`)) {
                    rules = JSON.parse(JSON.stringify(i18n[currentLanguage].rules));
                    localStorage.removeItem('kingscup-rules');
                    
                    // Update inputs
                    populateSettingsInputs();
                    
                    alert(`‚úÖ ${t('reset')}!`);
                }
            }

            // Event Listeners for clicking/tapping/pressing space/enter
            cardClickableArea.addEventListener('click', ()=>{
                if (gameStarted) drawCard();
            });
            cardClickableArea.addEventListener('keydown', (e)=>{ 
                if(e.key === ' ' || e.key === 'Enter'){ 
                    e.preventDefault(); 
                    if (gameStarted) drawCard();
                } 
            });

            // --- MODAL EVENT LISTENERS ---
            modalRollDiceBtn.addEventListener('click', handleDiceRoll); // <-- New listener
            modalCloseBtn.addEventListener('click', hideModal);
            ruleModal.addEventListener('click', (e) => {
                // Only close if clicking the backdrop, not the content
                // And only if the close button is visible (i.e., not waiting for a roll)
                if (e.target === ruleModal && !modalCloseBtn.classList.contains('hidden')) {
                    hideModal();
                }
            });

            rulesModalCloseBtn.addEventListener('click', hideRulesModal);
            rulesModal.addEventListener('click', (e) => {
                if (e.target === rulesModal) {
                    hideRulesModal();
                }
            });

            settingsModalCloseBtn.addEventListener('click', hideSettingsModal);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    hideSettingsModal();
                }
            });

            // --- Updated Summary Modal Close/Click Listener ---
            summaryModalCloseBtn.addEventListener('click', restartGame); // Call restartGame instead of handleReset
            summaryModal.addEventListener('click', (e) => {
                if (e.target === summaryModal) {
                   restartGame(); // Call restartGame instead of handleReset
                }
            });


            // --- BUTTON EVENT LISTENERS ---
            resetBtn.addEventListener('click', handleReset);
            rulesBtn.addEventListener('click', showRulesModal);
            settingsBtn.addEventListener('click', showSettingsModal);
            saveRulesBtn.addEventListener('click', saveCustomRules);
            resetRulesBtn.addEventListener('click', resetToDefaultRules);
            
            // Welcome modal listeners
            decreasePlayersBtn.addEventListener('click', () => updatePlayerCount(-1));
            increasePlayersBtn.addEventListener('click', () => updatePlayerCount(1));
            startGameBtn.addEventListener('click', startGame);


            // --- LANGUAGE FUNCTIONS ---
            langBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click listener from closing immediately
                langDropdown.classList.toggle('active');
            });

            langOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    const lang = e.currentTarget.getAttribute('data-lang');
                    setLanguage(lang);
                    langDropdown.classList.remove('active');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                // Check if the click target is outside the dropdown
                if (!langDropdown.contains(e.target)) {
                    langDropdown.classList.remove('active');
                }
            });


            // --- ***** INITIALIZATION ***** ---
            
            // Init deck
            createDeck(); 
            shuffle(); 

            // Seed first card face (before flip)
            centerSuit.textContent = 'üëë'; 
            rankTop.textContent=''; 
            rankBottom.textContent=''; 
            suitTop.textContent=''; 
            suitBottom.textContent='';
            centerSuit.className = 'text-8xl font-extrabold suit-red';
            
            // Set initial language and load rules
            loadRules(); // Load custom/default rules first
            setLanguage(currentLanguage); // Apply language (also calls populateSettingsInputs)
            
            // Check if names are saved and initialize welcome modal accordingly
            const savedNames = loadPlayerNames();
            if (savedNames) {
                 // Pre-fill and check the box
                playerCountInput.value = savedNames.length; 
                savePlayersCheckbox.checked = true;
                generatePlayerInputs(); // Generate inputs with saved names
                showWelcomeModal(); // Show the modal pre-filled
            } else {
                // No saved names, show modal with defaults
                savePlayersCheckbox.checked = false;
                generatePlayerInputs(); // Generate default empty inputs
                showWelcomeModal(); 
            }
           
        </script>
    </body>
</html>

